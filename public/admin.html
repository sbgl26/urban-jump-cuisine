<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Urban Jump</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#111;color:#fff;padding:20px;min-height:100vh}
        .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;padding-bottom:20px;border-bottom:1px solid #333}
        h1{font-size:24px;font-weight:600}
        .header-right{display:flex;align-items:center;gap:15px}
        .parc-badge{background:#333;padding:6px 12px;border-radius:4px;font-size:14px;color:#888}
        .link{color:#666;text-decoration:none;font-size:14px}.link:hover{color:#fff}
        .upload-zone{background:#1a1a1a;border:2px dashed #333;border-radius:8px;padding:40px;text-align:center;margin-bottom:30px;cursor:pointer;transition:all .2s}
        .upload-zone:hover{border-color:#555;background:#222}
        .upload-zone input{display:none}
        .upload-zone p{color:#666;margin-top:10px}
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:20px}
        .card{background:#1a1a1a;border:1px solid #282828;border-radius:8px;overflow:hidden}
        .card-header{background:#222;padding:15px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:flex-start}
        .card-title{font-weight:600;font-size:16px}
        .card-subtitle{color:#666;font-size:13px;margin-top:4px}
        .card-time{font-size:24px;font-weight:700;color:#fff}
        .card-body{padding:15px}
        .field{margin-bottom:12px}
        .field-label{font-size:11px;color:#666;text-transform:uppercase;margin-bottom:4px}
        .field-value{font-size:14px;color:#ccc}
        .field-row{display:flex;gap:10px;align-items:center}
        .field-input{background:#222;border:1px solid #333;color:#fff;padding:8px 12px;border-radius:4px;width:80px;font-size:14px}
        .field-input:focus{outline:none;border-color:#555}
        .btn{padding:8px 16px;border:none;border-radius:4px;cursor:pointer;font-size:13px;font-weight:500;transition:all .2s}
        .btn-primary{background:#2a4a8a;color:#fff}.btn-primary:hover{background:#3a5a9a}
        .btn-danger{background:#4a2a2a;color:#f88}.btn-danger:hover{background:#5a3a3a}
        .btn-small{padding:5px 10px;font-size:12px}
        .options{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
        .option-tag{background:#2a2a2a;padding:4px 10px;border-radius:4px;font-size:12px;color:#888;cursor:pointer;border:1px solid #333}
        .option-tag.active{background:#2a4a3a;color:#8c8;border-color:#3a5a4a}
        .option-tag:hover{border-color:#555}
        .status-row{display:flex;gap:10px;margin-top:15px;padding-top:15px;border-top:1px solid #282828}
        .status-btn{flex:1;padding:12px;border:1px solid #333;background:#222;color:#666;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;text-transform:uppercase;transition:all .2s;text-align:center}
        .status-btn:hover{background:#2a2a2a;color:#888}
        .status-btn.orange{background:#3a2a0a;border-color:#5a4a2a;color:#fa0}
        .status-btn.done{background:#1a3a1a;border-color:#2a5a2a;color:#6c6}
        .textarea{width:100%;background:#222;border:1px solid #333;color:#fff;padding:8px;border-radius:4px;font-size:13px;resize:vertical;min-height:60px}
        .message{padding:15px;border-radius:6px;margin-bottom:20px;text-align:center}
        .message.success{background:#1a3a1a;color:#8c8;border:1px solid #2a5a2a}
        .message.error{background:#3a1a1a;color:#f88;border:1px solid #5a2a2a}
    </style>
</head>
<body>
    <div class="header">
        <h1>URBAN JUMP - ADMIN <span class="parc-badge" id="parcBadge"></span></h1>
        <div class="header-right">
            <a href="#" id="linkCuisine" class="link">‚Üê √âcran cuisine</a>
        </div>
    </div>
    
    <div id="message"></div>
    
    <div class="upload-zone" id="uploadZone">
        <h3>üìÑ Importer PDF Qweekle</h3>
        <p>Cliquez ou glissez le fichier ici</p>
        <input type="file" id="fileInput" accept=".pdf">
    </div>
    
    <div class="grid" id="grid"></div>
    
    <script>
        const PARC = window.location.pathname.split('/')[1] || 'default';
        document.getElementById('parcBadge').textContent = PARC.toUpperCase();
        document.getElementById('linkCuisine').href = `/${PARC}`;
        
        let reservations = [], validations = {};
        
        // Upload
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.style.borderColor = '#888'; });
        uploadZone.addEventListener('dragleave', () => uploadZone.style.borderColor = '#333');
        uploadZone.addEventListener('drop', e => {
            e.preventDefault();
            uploadZone.style.borderColor = '#333';
            if (e.dataTransfer.files[0]) uploadFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', e => { if (e.target.files[0]) uploadFile(e.target.files[0]); });
        
        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('pdf', file);
            try {
                const res = await fetch(`/${PARC}/api/upload`, { method: 'POST', body: formData });
                const data = await res.json();
                showMessage(`${data.count} anniversaires import√©s`, 'success');
                loadData();
            } catch (err) {
                showMessage('Erreur upload', 'error');
            }
        }
        
        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => msg.innerHTML = '', 4000);
        }
        
        async function loadData() {
            const res = await fetch(`/${PARC}/api/reservations`);
            const data = await res.json();
            reservations = (data.reservations || []).filter(r => !r.done);
            validations = data.validations || {};
            render();
        }
        
        function render() {
            const grid = document.getElementById('grid');
            if (reservations.length === 0) {
                grid.innerHTML = '<p style="color:#666;grid-column:1/-1;text-align:center;padding:40px">Aucun anniversaire</p>';
                return;
            }
            
            grid.innerHTML = reservations.map(r => {
                const v = validations[r.id] || {};
                const arriveState = v.arrive || null;
                const paiementDone = v.paiement || false;
                
                return `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${r.enfant}</div>
                            <div class="card-subtitle">${r.client} - ${r.telephone}</div>
                        </div>
                        <div class="card-time">${r.heureRepas}</div>
                    </div>
                    <div class="card-body">
                        <div class="field">
                            <div class="field-label">Formule</div>
                            <div class="field-value">${r.formule} ‚Ä¢ ${r.heureDebut} ‚Üí ${r.heureRepas}</div>
                        </div>
                        <div class="field">
                            <div class="field-label">Nombre d'enfants</div>
                            <div class="field-row">
                                <input type="number" class="field-input" value="${r.nbEnfants}" min="1" max="50" onchange="updateField('${r.id}','nbEnfants',this.value)">
                                <span style="color:#666;font-size:12px">(${r.age} ans)</span>
                            </div>
                        </div>
                        <div class="field">
                            <div class="field-label">Pizzas suppl√©mentaires</div>
                            <input type="number" class="field-input" value="${r.pizzasExtra || 0}" min="0" max="20" onchange="updateField('${r.id}','pizzasExtra',this.value)">
                        </div>
                        <div class="field">
                            <div class="field-label">G√¢teau</div>
                            <div class="field-value">${r.gateauType || 'Non sp√©cifi√©'}</div>
                        </div>
                        <div class="field">
                            <div class="field-label">Option texte libre</div>
                            <textarea class="textarea" placeholder="Ex: Allergie gluten, demande sp√©ciale..." onchange="updateField('${r.id}','optionTexte',this.value)">${r.optionTexte || ''}</textarea>
                        </div>
                        <div class="field">
                            <div class="field-label">Options</div>
                            <div class="options">
                                <span class="option-tag ${r.reine?'active':''}" onclick="toggleOption('${r.id}','reine')">Reine</span>
                                <span class="option-tag ${r.marguerite?'active':''}" onclick="toggleOption('${r.id}','marguerite')">Marguerite</span>
                                <span class="option-tag ${r.champagne?'active':''}" onclick="toggleOption('${r.id}','champagne')">Champagne</span>
                                <span class="option-tag ${r.pochettes?'active':''}" onclick="toggleOption('${r.id}','pochettes')">Pochettes</span>
                            </div>
                        </div>
                        
                        <div class="status-row">
                            <div class="status-btn ${arriveState === 'orange' ? 'orange' : (arriveState === 'done' ? 'done' : '')}" onclick="toggleArrive('${r.id}')">
                                ${arriveState === 'done' ? '‚úì ' : ''}ARRIV√âE
                            </div>
                            <div class="status-btn ${paiementDone ? 'done' : ''}" onclick="togglePaiement('${r.id}')">
                                ${paiementDone ? '‚úì ' : ''}PAIEMENT
                            </div>
                        </div>
                        
                        <div style="margin-top:15px;text-align:right">
                            <button class="btn btn-danger btn-small" onclick="deleteReservation('${r.id}')">Supprimer</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        async function updateField(id, field, value) {
            await fetch(`/${PARC}/api/reservation/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ [field]: field === 'optionTexte' ? value : Number(value) })
            });
            loadData();
        }
        
        async function toggleOption(id, option) {
            const r = reservations.find(x => x.id === id);
            const newValue = r[option] ? 0 : 1;
            await fetch(`/${PARC}/api/reservation/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ [option]: newValue })
            });
            loadData();
        }
        
        async function toggleArrive(resId) {
            const current = validations[resId]?.arrive || null;
            let newValue;
            if (current === null) newValue = 'orange';
            else if (current === 'orange') newValue = 'done';
            else newValue = null;
            
            if (newValue === null) {
                await fetch(`/${PARC}/api/unvalidate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reservationId: resId, type: 'arrive' })
                });
            } else {
                await fetch(`/${PARC}/api/validate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reservationId: resId, type: 'arrive', value: newValue })
                });
            }
            loadData();
        }
        
        async function togglePaiement(resId) {
            const current = validations[resId]?.paiement;
            const endpoint = current ? `/${PARC}/api/unvalidate` : `/${PARC}/api/validate`;
            await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reservationId: resId, type: 'paiement' })
            });
            loadData();
        }
        
        async function deleteReservation(id) {
            if (!confirm('Supprimer cet anniversaire ?')) return;
            await fetch(`/${PARC}/api/reservation/${id}`, { method: 'DELETE' });
            loadData();
        }
        
        setInterval(loadData, 5000);
        loadData();
    </script>
</body>
</html>
